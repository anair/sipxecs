#!/bin/bash
#
# Copyright (C) 2004 SIPfoundry Inc.
# Licensed by SIPfoundry under the LGPL license.
#
# Copyright (C) 2004 Pingtel Corp.
# Licensed to SIPfoundry under a Contributor Agreement.

Action=RUN
Status=0
Args=""

iam=`whoami`

while [ $# -ne 0 ]
do
    case ${1} in
        --configtest)
            Action=CONFIGTEST
            ;;

        --stop)
            Action=STOP
            ;;

        *)
            Args="$Args $1"
            ;;
    esac           

    shift # always consume 1
done

. @SIPX_LIBEXECDIR@/sipx-utils.sh || exit 1

SIPX_USER=@SIPXPBXUSER@
SIPX_VARDIR=@SIPX_VARDIR@

SIPXDIRS="@FREESWITCH_PREFIX@/log @FREESWITCH_PREFIX@/db @FREESWITCH_PREFIX@/conf"

# Create additional directories
if [ ! -d @FREESWITCH_PREFIX@/log ]
then
  mkdir @FREESWITCH_PREFIX@/log
fi

if [ ! -d @FREESWITCH_PREFIX@/db ]
then
  mkdir @FREESWITCH_PREFIX@/db
fi

chown -R $SIPX_USER:$SIPX_USER $SIPXDIRS

case ${Action} in
   RUN)
     exec @FREESWITCH_PREFIX@/bin/freeswitch -nc -nf $Args
     exit 0
     ;;

   STOP)
     @FREESWITCH_PREFIX@/bin/freeswitch -stop
     exit $?
     ;;

   CONFIGTEST)
     WRONGPERM=`find $SIPXDIRS -not -user $SIPX_USER -or -not -group $SIPX_USER | wc -l`
     if [ $WRONGPERM -gt 0 ] 
     then
        if [ $iam = root ]
        then
           Status=0
           echo -e "\n Fixing FreeSWITCH folder permissions \n"
           chown -R $SIPX_USER:$SIPX_USER $SIPXDIRS
        else
           Status=1
           echo -e "\n Invalid FreeSWITCH folders & files permissions, run 'freeswitch.sh --configtest' as root to fix this \n"
        fi  
     fi
     # check validity of xml routing rules
#     @SIPX_BINDIR@/sipx-validate-xml @FREESWITCH_PREFIX@/conf/freeswitch.xml
#     Status=$?

     ;;
esac

exit $Status

