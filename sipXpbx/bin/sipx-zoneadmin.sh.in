#!/bin/sh

OPERATION="ZoneAdmin"
source /usr/bin/sipx-archive-common

# Look for the INTERACTIVE flag first, before processing any other command-line arguments.
INTERACTIVE="yes"
for arg in "$@"
do
  case $arg in
    -n|--non-interactive)
      INTERACTIVE="no"
      # Re-direct stderr and stdout to a log file.
      rm -rf /var/log/sipxpbx/sipx-zoneadmin.log
      exec 3<>/var/log/sipxpbx/sipx-zoneadmin.log
      exec 2>&3
      exec 1>&3
      ;;
  esac
done

operation_stamp

if [ "`whoami`" != root ]
then
  echo "You must be root in order to regenerate zone files."
  exit 4
fi

usage() {
  echo
  echo Usage: $0 parameters
  echo
  echo "   Regenerate the specified zone files."
  echo
  echo Parameters:
  echo "   -h|--help                     Display this help text."
  echo "   -n|--non-interactive          Do not run in interactive mode."
  echo
}

# Process the rest of the command-line arguments.
while [ $# -ne 0 ]
do
  case ${1} in
    -n|--non-interactive)
      # Ignore at this point.
      ;;

    -h|--help)
      usage
      exit
      ;;

    *)
      Args="$Args $1"
      ;;
    esac
  shift # always consume one argument
done

# Generate the zone file
domname=`dnsdomainname`
echo "Generating zone file for:"
echo $domname
echo $Args
@SIPX_BINDIR@/sipx-dns $domname $Args > /var/named/${domname}.zone
chgowner=`/bin/chown named:named /var/named/${domname}.zone`

# Reload the zone files into the DNS server.
# If the DNS server is not running this will do nothing.
reload=`/usr/sbin/rndc reload`
echo $reload
