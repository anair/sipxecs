#!@bash@
##
## create-ssl-keystore.sh
##
##  Copyright (C) 2007 Pingtel Corp., certain elements licensed under a Contributor Agreement.  
##  Contributors retain copyright to elements licensed under a Contributor Agreement.
##  Licensed to the User under the LGPL license.
##

Action=CREATE
SslDir="@sipxpbx.conf.dir@/ssl"
WebCertificate="$SslDir/ssl-web.crt"
WebKey="$SslDir/ssl-web.key"
Certificate="$SslDir/ssl.crt"
Key="$SslDir/ssl.key"
KeyStorePkcs12="$SslDir/.ssl.p12"
KeyStore="$SslDir/.ssl.keystore"
Password="changeit"
KeyStoreFilesChecksum="${KeyStore}-contents.md5"
Checksum=""
PreviousChecksum=""
openssl="@openssl@"


if [ -f $WebCertificate ]; then
  Certificate=$WebCertificate
fi
if [ -f $WebKey ]; then
  Key=$WebKey
fi


if [ `uname -s` = FreeBSD ] ; then
  MD5SUM="/sbin/md5 -r"
else
  MD5SUM=md5sum
fi

Checksum=`cat $Certificate $Key | $MD5SUM | awk '{print $1}'`
if [ -f $KeyStoreFilesChecksum ]; then
  if [ -f $KeyStore ]; then
    PreviousChecksum=`cat $KeyStoreFilesChecksum`
    if [ x"$Checksum" = x"$PreviousChecksum" ]; then
      echo "Creating $KeyStore was skipped, previous checksum of contents matched"
      exit 0;
    fi
  fi
fi

rm $KeyStorePkcs12 2> /dev/null

caname="`$openssl x509 -noout -text -in \"$Certificate\" |\
           grep Issuer: | sed -e 's;.*CN=;;' -e 's;/Em.*;;'`"

servername="`$openssl x509 -noout -text -in \"$Certificate\" |\
           grep Subject: | sed -e 's;.*CN=;;' -e 's;/Em.*;;'`"

$openssl pkcs12 -export \
  -password "pass:$Password" \
  -in "$Certificate" \
  -inkey $Key \
  -name "$servername" \
  -caname "$caname" \
  -out "$KeyStorePkcs12" || exit 1

rm $KeyStore 2> /dev/null
JavaCmd=`@bin.dir@/sipx-config --java`
echo -e "$Password\n$Password" | 
  $JavaCmd \
  -classpath @sipxconfig.lib.dir@/sipxconfig.jar \
  org.mortbay.util.PKCS12Import $KeyStorePkcs12 $KeyStore

#echo -e "$Password\n$Password" | 
#  $JavaCmd \
#  -classpath @sipxconfig.lib.dir@/sipxconfigjetty-*.jar \
#  org.mortbay.util.PKCS12Import $KeyStorePkcs12 $KeyStore

echo $Checksum > ${KeyStoreFilesChecksum}
