#!/bin/bash
#
# Copyright (C) 2004 SIPfoundry Inc.
# Licensed by SIPfoundry under the LGPL license.
#
# Copyright (C) 2004 Pingtel Corp.
# Licensed to SIPfoundry under a Contributor Agreement.

Action=RUN
Status=0
Args=""

iam=`whoami`

while [ $# -ne 0 ]
do
    case ${1} in
        --configtest)
            Action=CONFIGTEST
            ;;

        --stop)
            Action=STOP
            ;;

        *)
            Args="$Args $1"
            ;;
    esac           

    shift # always consume 1
done

. @SIPX_LIBEXECDIR@/sipx-utils.sh || exit 1

CONFIG_DEFS="@SIPX_CONFDIR@/config.defs"
FS_CONFIG_DEFS="@SIPX_CONFDIR@/freeswitch_config.defs"
SIPX_USER=@SIPXPBXUSER@
SIPX_VARDIR=@SIPX_VARDIR@

CONFIG_FILES="\
  @FREESWITCH_PREFIX@/conf/freeswitch.xml \
  @FREESWITCH_PREFIX@/conf/sofia.conf.xml \
  @FREESWITCH_PREFIX@/conf/xml_rpc.conf.xml \
  @FREESWITCH_PREFIX@/conf/modules.conf.xml"
# If the "config.defs" file exists and the <name>.in file exists for a
# configuration file, then run the config preprocessor to generate the
# fully resolved configuration file.

SIPXDIRS="@FREESWITCH_PREFIX@/log @FREESWITCH_PREFIX@/db @FREESWITCH_PREFIX@/conf"

if [ -f $CONFIG_DEFS -a -f $FS_CONFIG_DEFS ]
then
  cat $CONFIG_DEFS $FS_CONFIG_DEFS > $SIPX_VARDIR/tmp/fs_config.defs
  for i in $CONFIG_FILES ; do
    if [ -f "${i}.in" ]
    then
       @SIPX_BINDIR@/configpp --defs $SIPX_VARDIR/tmp/fs_config.defs --in "${i}.in" --out "$i"
    fi
  done
  rm -f $SIPX_VARDIR/tmp/fs_config.defs

  # Create additional directories
  if [ ! -d @FREESWITCH_PREFIX@/log ]
  then
    mkdir @FREESWITCH_PREFIX@/log
  fi

  if [ ! -d @FREESWITCH_PREFIX@/db ]
  then
    mkdir @FREESWITCH_PREFIX@/db
  fi

  chown -R $SIPX_USER:$SIPX_USER $SIPXDIRS
fi

case ${Action} in
   RUN)
     exec @FREESWITCH_PREFIX@/bin/freeswitch -nc -nf $Args
     exit 0
     ;;

   STOP)
     @FREESWITCH_PREFIX@/bin/freeswitch -stop
     exit $?
     ;;

   CONFIGTEST)
     WRONGPERM=`find $SIPXDIRS -not -user $SIPX_USER -or -not -group $SIPX_USER | wc -l`
     if [ $WRONGPERM -gt 0 ] 
     then
        if [ $iam = root ]
        then
           Status=0
           echo -e "\n Fixing FreeSWITCH folder permissions \n"
           chown -R $SIPX_USER:$SIPX_USER $SIPXDIRS
        else
           Status=1
           echo -e "\n Invalid FreeSWITCH folders & files permissions, run 'freeswitch.sh --configtest' as root to fix this \n"
        fi  
     fi
     # check validity of xml routing rules
#     @SIPX_BINDIR@/sipx-validate-xml @FREESWITCH_PREFIX@/conf/freeswitch.xml
#     Status=$?

     ;;
esac

exit $Status

